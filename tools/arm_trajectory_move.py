#!/usr/bin/env python3

import json
import time
import requests
from datetime import datetime
import numpy as np


def generate_trajectory_points(positions_list):
    points = []
    for i, positions in enumerate(positions_list):
        point = {
            "time_since_reference": 0.0,
            "positions": positions,
        }
        points.append(point)
    return points


def interpolate_trajectory_points(start_position, end_position):
    points = []
    start_position = np.array(start_position)
    end_position = np.array(end_position)
    num = 2000
    for i in range(num):
        position = start_position + \
            (end_position - start_position) * i / (num - 1)
        point = {
            "time_since_reference": 0.0,
            "positions": position.tolist(),
        }
        points.append(point)
    return points


def create_header():
    now = datetime.utcnow()
    header = {
        "timestamp": {
            "seconds": int(now.timestamp()),
            "nanos": now.microsecond * 1000,
            "ms_since_epoch": int(now.timestamp() * 1000),
        },
        "control_source": "ControlSource_MANUAL"
    }
    return header


def generate_json(left_positions_list, right_positions_list, interpolate=False):
    if interpolate:
        left_trajectory_points = interpolate_trajectory_points(
            left_positions_list[0], left_positions_list[1])
        right_trajectory_points = interpolate_trajectory_points(
            right_positions_list[0], right_positions_list[1])
    else:
        left_trajectory_points = generate_trajectory_points(
            left_positions_list)
        right_trajectory_points = generate_trajectory_points(
            right_positions_list)
    data = {
        "header": create_header(),
        "target": {
            "left": {
                "reference_time": 0.0,
                "points": left_trajectory_points
            },
            "right": {
                "reference_time": 0.0,
                "points": right_trajectory_points
            }
        }
    }
    return data


def send_json_data(json_data, url):
    json_str = json.dumps(json_data, indent=2)
    print("Sending JSON data:")
    print(json_str)
    print("")

    headers = {'content-type': 'application/json'}
    response = requests.post(url, headers=headers, data=json_str)

    print(f"Response: {response.status_code}")
    print(response.text)
    print("")


def main():
    left_positions_list = [
       [
	-0.10545928031206131
	1.254409909248352
	 0
	 -0.7177416086196899
	 1.499998688697815
	 -0.0004906999690468513
	 0.002540077572709486
        ]
        # [0.24, -1.4, 1.5708, 0.8, 0, 0, 0],
        # [0.44, -1.1, 1.3708, 1.0, 0, 0, 0],
        # [0.64, -0.8, 1.1708, 1.2, 0, 0, 0],
        # [0., 0., 0., 0., 0., 0., 0.],
    ]

    right_positions_list = [
        # fixed set point
        # [-0.24, -1.4, -1.5708, 0.8, 0, 0, 0],
        # [-0.44, -1.1, -1.3708, 1.0, 0, 0, 0],
        # [-0.64, -0.8, -1.1708, 1.2, 0, 0, 0],
        # [0., 0., 0., 0., 0., 0., 0.],
        # fixed set point
        # [0.369, -1.347, -1.652, 0.980, 0.305, 0.025, -0.168],
        # [1.459, -1.506, -1.844, 0.172, 0.176, 0.569, 0.027],
        # fixed set points
        [
            0.36899998784065247,
            -1.347000002861023,
            -1.6519999504089355,
            0.9800000190734863,
            0.3050000071525574,
            0.02500000037252903,
            -0.1679999977350235
        ],
        [
            0.37786006927490234,
            -1.3195319175720215,
            -1.6841814517974854,
            1.014435052871704,
            0.334090918302536,
            0.05035781487822533,
            -0.1522996872663498
        ],
        [
            0.3867201507091522,
            -1.29206383228302,
            -1.7163629531860352,
            1.0488700866699219,
            0.36318182945251465,
            0.07571563124656677,
            -0.1365993618965149
        ],
        [
            0.3955802619457245,
            -1.2645957469940186,
            -1.7485445737838745,
            1.0833052396774292,
            0.3922727108001709,
            0.10107344388961792,
            -0.12089905142784119
        ],
        [
            0.40444034337997437,
            -1.2371277809143066,
            -1.7807260751724243,
            1.117740273475647,
            0.4213636517524719,
            0.12643125653266907,
            -0.10519874095916748
        ],
        [
            0.41330042481422424,
            -1.2096596956253052,
            -1.8129075765609741,
            1.1521753072738647,
            0.4504545331001282,
            0.1517890840768814,
            -0.08949843049049377
        ],
        [
            0.4221605062484741,
            -1.1821916103363037,
            -1.8450891971588135,
            1.1866103410720825,
            0.4795454442501068,
            0.17714689671993256,
            -0.07379811257123947
        ],
        [
            0.431020587682724,
            -1.1547235250473022,
            -1.8772706985473633,
            1.2210453748703003,
            0.5086363554000854,
            0.2025047093629837,
            -0.05809779465198517
        ],
        [
            0.4398806691169739,
            -1.1272554397583008,
            -1.909452199935913,
            1.2554805278778076,
            0.5377272367477417,
            0.22786252200603485,
            -0.04239748418331146
        ],
        [
            0.44874078035354614,
            -1.0997873544692993,
            -1.941633701324463,
            1.2899155616760254,
            0.5668181777000427,
            0.2532203197479248,
            -0.026697173714637756
        ],
        [
            0.457600861787796,
            -1.0723192691802979,
            -1.9738152027130127,
            1.3243505954742432,
            0.5959091186523438,
            0.27857816219329834,
            -0.01099686324596405
        ],
        [
            0.4664609432220459,
            -1.044851303100586,
            -2.0059967041015625,
            1.358785629272461,
            0.625,
            0.3039359748363495,
            0.00470346212387085
        ],
        [
            0.4753210246562958,
            -1.017383098602295,
            -2.0381784439086914,
            1.3932206630706787,
            0.6540908813476562,
            0.32929378747940063,
            0.020403772592544556
        ],
        [
            0.48418110609054565,
            -0.9899150729179382,
            -2.070359945297241,
            1.4276556968688965,
            0.6831817626953125,
            0.3546516001224518,
            0.03610408306121826
        ],
        [
            0.4930412173271179,
            -0.9624470472335815,
            -2.102541446685791,
            1.4620907306671143,
            0.7122727036476135,
            0.38000941276550293,
            0.05180440843105316
        ],
        [
            0.5019012689590454,
            -0.9349789619445801,
            -2.134722948074341,
            1.4965258836746216,
            0.7413636445999146,
            0.4053672254085541,
            0.06750471889972687
        ],
        [
            0.5107613801956177,
            -0.9075108766555786,
            -2.1669044494628906,
            1.5309609174728394,
            0.7704545259475708,
            0.4307250380516052,
            0.08320502936840057
        ],
        [
            0.5222135186195374,
            -0.912564754486084,
            -2.1723434925079346,
            1.5166021585464478,
            0.7721039056777954,
            0.42673856019973755,
            0.08126839250326157
        ],
        [
            0.5336110591888428,
            -0.9176848530769348,
            -2.1777312755584717,
            1.5021188259124756,
            0.7737542390823364,
            0.42269188165664673,
            0.07925260066986084
        ],
        [
            0.5449565649032593,
            -0.9228727221488953,
            -2.18306827545166,
            1.4875057935714722,
            0.7754226326942444,
            0.4185836911201477,
            0.07715867459774017
        ],
        [
            0.556252658367157,
            -0.9281293749809265,
            -2.1883552074432373,
            1.472762107849121,
            0.7770716547966003,
            0.41441282629966736,
            0.07498522847890854
        ],
        [
            0.5675013661384583,
            -0.933456301689148,
            -2.1935911178588867,
            1.4578825235366821,
            0.7787251472473145,
            0.4101782441139221,
            0.0727338120341301
        ],
        [
            0.5787047147750854,
            -0.9388545155525208,
            -2.198777198791504,
            1.4428642988204956,
            0.7803596258163452,
            0.4058784544467926,
            0.07040280848741531
        ],
        [
            0.5898656249046326,
            -0.9443257451057434,
            -2.203913450241089,
            1.4277019500732422,
            0.7820256352424622,
            0.40151268243789673,
            0.06799406558275223
        ],
        [
            0.6009865999221802,
            -0.9498713612556458,
            -2.209000587463379,
            1.4123930931091309,
            0.7836589813232422,
            0.3970784544944763,
            0.06550521403551102
        ],
        [
            0.612069845199585,
            -0.9554932117462158,
            -2.214038372039795,
            1.3969323635101318,
            0.7852996587753296,
            0.3925743103027344,
            0.06293760985136032
        ],
        [
            0.6231181025505066,
            -0.9611928462982178,
            -2.219027519226074,
            1.3813155889511108,
            0.7869372367858887,
            0.38799920678138733,
            0.06029070168733597
        ],
        [
            0.63413405418396,
            -0.9669724702835083,
            -2.223968029022217,
            1.3655370473861694,
            0.7885653376579285,
            0.3833509087562561,
            0.05756320431828499
        ],
        [
            0.6451206207275391,
            -0.9728338122367859,
            -2.2288599014282227,
            1.3495917320251465,
            0.7901965379714966,
            0.3786279857158661,
            0.05475500971078873
        ],
        [
            0.6560801267623901,
            -0.9787788391113281,
            -2.233703374862671,
            1.3334739208221436,
            0.7918182611465454,
            0.37382829189300537,
            0.05186549201607704
        ],
        [
            0.6670156121253967,
            -0.9848101735115051,
            -2.238497734069824,
            1.3171788454055786,
            0.7934294939041138,
            0.3689495325088501,
            0.048893675208091736
        ],
        [
            0.6779301762580872,
            -0.9909298419952393,
            -2.2432446479797363,
            1.3006997108459473,
            0.7950323820114136,
            0.3639892637729645,
            0.045838940888643265
        ],
        [
            0.6888273358345032,
            -0.9971408843994141,
            -2.247943162918091,
            1.2840291261672974,
            0.7966214418411255,
            0.35894575715065,
            0.042699314653873444
        ],
        [
            0.6997095346450806,
            -1.0034453868865967,
            -2.252593517303467,
            1.267160415649414,
            0.7982210516929626,
            0.35381606221199036,
            0.039474520832300186
        ],
        [
            0.7105811834335327,
            -1.0098472833633423,
            -2.2571964263916016,
            1.2500858306884766,
            0.799781858921051,
            0.34859710931777954,
            0.0361623652279377
        ],
        [
            0.7214452624320984,
            -1.0163493156433105,
            -2.2617506980895996,
            1.2327979803085327,
            0.8013511300086975,
            0.34328627586364746,
            0.032762158662080765
        ],
        [
            0.7323052883148193,
            -1.0229547023773193,
            -2.266256809234619,
            1.215287446975708,
            0.8028886318206787,
            0.3378807008266449,
            0.02927093580365181
        ],
        [
            0.7431656122207642,
            -1.0296672582626343,
            -2.27071475982666,
            1.197544813156128,
            0.8044291734695435,
            0.33237722516059875,
            0.02568805031478405
        ],
        [
            0.7540295124053955,
            -1.036490559577942,
            -2.2751243114471436,
            1.1795623302459717,
            0.8059535026550293,
            0.32677125930786133,
            0.02201063185930252
        ],
        [
            0.764902651309967,
            -1.0434297323226929,
            -2.279484748840332,
            1.161325216293335,
            0.8074489235877991,
            0.32105961441993713,
            0.01823592372238636
        ],
        [
            0.7757891416549683,
            -1.0504891872406006,
            -2.283796548843384,
            1.1428241729736328,
            0.8089371919631958,
            0.31523770093917847,
            0.01436204556375742
        ],
        [
            0.78669273853302,
            -1.0576729774475098,
            -2.288057327270508,
            1.1240484714508057,
            0.8103926181793213,
            0.30930161476135254,
            0.010385904461145401
        ],
        [
            0.7976200580596924,
            -1.064987301826477,
            -2.2922701835632324,
            1.1049811840057373,
            0.8118685483932495,
            0.30324533581733704,
            0.006303955800831318
        ],
        [
            0.8085762858390808,
            -1.0724384784698486,
            -2.2964298725128174,
            1.085608959197998,
            0.8132838606834412,
            0.29706475138664246,
            0.002112255897372961
        ],
        [
            0.8195676207542419,
            -1.080032229423523,
            -2.3005380630493164,
            1.0659173727035522,
            0.8146584630012512,
            0.29075345396995544,
            -0.002193568740040064
        ],
        [
            0.8305994868278503,
            -1.087775468826294,
            -2.3045945167541504,
            1.0458873510360718,
            0.8160302639007568,
            0.2843049168586731,
            -0.006616454571485519
        ],
        [
            0.8416797518730164,
            -1.095676302909851,
            -2.30859637260437,
            1.025499939918518,
            0.8173767924308777,
            0.2777120769023895,
            -0.011162450537085533
        ],
        [
            0.8528161644935608,
            -1.103743314743042,
            -2.3125414848327637,
            1.0047342777252197,
            0.8186740875244141,
            0.2709684371948242,
            -0.015837393701076508
        ],
        [
            0.8640169501304626,
            -1.1119861602783203,
            -2.316429615020752,
            0.9835656881332397,
            0.8199223875999451,
            0.2640635073184967,
            -0.020647473633289337
        ],
        [
            0.8752903938293457,
            -1.120414137840271,
            -2.320258855819702,
            0.9619713425636292,
            0.8211769461631775,
            0.2569900453090668,
            -0.025598259642720222
        ],
        [
            0.8866469264030457,
            -1.1290392875671387,
            -2.3240251541137695,
            0.9399223923683167,
            0.8223631381988525,
            0.2497362345457077,
            -0.030699025839567184
        ],
        [
            0.898098349571228,
            -1.1378750801086426,
            -2.3277268409729004,
            0.9173851609230042,
            0.8234989047050476,
            0.2422909438610077,
            -0.03595879673957825
        ],
        [
            0.9096561074256897,
            -1.146935224533081,
            -2.3313584327697754,
            0.8943255543708801,
            0.8245740532875061,
            0.2346411645412445,
            -0.041386377066373825
        ],
        [
            0.9213343262672424,
            -1.1562364101409912,
            -2.334916830062866,
            0.870703399181366,
            0.8255959153175354,
            0.2267722487449646,
            -0.04699412360787392
        ],
        [
            0.9331482648849487,
            -1.1657966375350952,
            -2.3383967876434326,
            0.8464736938476562,
            0.8265517950057983,
            0.2186678647994995,
            -0.05279400199651718
        ],
        [
            0.9451160430908203,
            -1.1756374835968018,
            -2.3417892456054688,
            0.8215834498405457,
            0.8274069428443909,
            0.21030868589878082,
            -0.058802150189876556
        ],
        [
            0.9572582840919495,
            -1.1857835054397583,
            -2.345087766647339,
            0.7959721684455872,
            0.8281975388526917,
            0.20167265832424164,
            -0.06503427773714066
        ],
        [
            0.9695976972579956,
            -1.1962623596191406,
            -2.3482813835144043,
            0.7695722579956055,
            0.8288877010345459,
            0.1927347630262375,
            -0.07151231914758682
        ],
        [
            0.982162356376648,
            -1.2071075439453125,
            -2.351356029510498,
            0.742302417755127,
            0.8294375538825989,
            0.18346533179283142,
            -0.07825900614261627
        ],
        [
            0.9949842095375061,
            -1.218357801437378,
            -2.354294538497925,
            0.7140664458274841,
            0.8298419117927551,
            0.1738288700580597,
            -0.08530222624540329
        ],
        [
            1.0081018209457397,
            -1.2300598621368408,
            -2.3570737838745117,
            0.68474942445755,
            0.8301013112068176,
            0.16378425061702728,
            -0.09267571568489075
        ],
        [
            1.0215628147125244,
            -1.2422714233398438,
            -2.35966420173645,
            0.6542117595672607,
            0.8301178216934204,
            0.15327927470207214,
            -0.10042180120944977
        ],
        [
            1.0354232788085938,
            -1.2550605535507202,
            -2.3620238304138184,
            0.6222836375236511,
            0.8299030661582947,
            0.14225317537784576,
            -0.10859024524688721
        ],
        [
            1.0497589111328125,
            -1.2685188055038452,
            -2.364095687866211,
               0.5887432098388672,
            0.8293569087982178,
            0.13062399625778198,
            -0.11724745482206345
        ],
        [
            1.0572096109390259,
            -1.2756376266479492,
            -2.3649446964263916,
            0.5710307359695435,
            0.828868567943573,
            0.12445823848247528,
            -0.12186110019683838
        ],
        [
            1.0646603107452393,
            -1.2827565670013428,
            -2.3657937049865723,
            0.5533183217048645,
            0.8283802270889282,
            0.11829248070716858,
            -0.1264747530221939
        ],
        [
            1.0724568367004395,
            -1.2903414964675903,
            -2.3663930892944336,
            0.5344769358634949,
            0.827619731426239,
            0.11170728504657745,
            -0.13142931461334229
        ],
        [
            1.0802534818649292,
            -1.297926425933838,
            -2.366992235183716,
            0.5156355500221252,
            0.8268592357635498,
            0.10512208193540573,
            -0.13638387620449066
        ]

    ]

    url = 'http://127.0.0.1:56322/rpc/aimdk.protocol.McMotionService/TrajectoryMove'

    json_data = generate_json(
        left_positions_list, right_positions_list, interpolate=False)
    send_json_data(json_data, url)


if __name__ == "__main__":
    main()
